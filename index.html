<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åº§æ¨™ãƒãƒƒãƒ—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    #map {
      width: 100%;
      max-width: 1000px;
      height: 80vh;
      margin: 10px auto;
      background: #f4f4f4;
    }
    form, .filters, .nav-buttons {
      margin: 10px auto;
      max-width: 1000px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    label, input, select, button {
      font-size: 14px;
      padding: 5px;
    }
    input[type="text"], input[type="number"], select {
      width: 100px;
    }
    .nav-buttons a {
      text-decoration: none;
      font-weight: bold;
      padding: 6px 12px;
      background: #6c63ff;
      color: white;
      border-radius: 5px;
    }
    @media (max-width: 600px) {
      input, select, button {
        font-size: 12px;
        padding: 4px;
      }
      .nav-buttons a {
        font-size: 12px;
        padding: 5px 10px;
      }
    }
  </style>
</head>
<body>

<h2>ğŸ“ åº§æ¨™ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h2>
<form id="coordinateForm">
  <label>ã‚µãƒ¼ãƒãƒ¼å: <input type="text" name="ã‚µãƒ¼ãƒãƒ¼å" required></label>
  <label>X: <input type="number" name="X" required min="0" max="999"></label>
  <label>Y: <input type="number" name="Y" required min="0" max="999"></label>
  <label>ãƒ¬ãƒ™ãƒ«:
    <select name="ãƒ¬ãƒ™ãƒ«" required>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option>
    </select>
  </label>
  <button type="submit">ç™»éŒ²</button>
</form>

<div class="filters">
  <input type="text" id="filterServer" placeholder="ğŸ” ã‚µãƒ¼ãƒãƒ¼åã§æ¤œç´¢">
  <select id="filterLevel">
    <option value="">ğŸ” å…¨ãƒ¬ãƒ™ãƒ«</option>
    <option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option>
    <option value="4">Lv4</option><option value="5">Lv5</option><option value="6">Lv6</option><option value="7">Lv7</option>
  </select>
</div>

<div class="nav-buttons">
  <a href="list_uncollected.html" target="_blank">ğŸ“‹ æœªå–å¾—ä¸€è¦§</a>
  <a href="list_collected.html" target="_blank">ğŸ“‹ å–å¾—æ¸ˆã¿ä¸€è¦§</a>
</div>

<div id="map"></div>

<script>
  // âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰åˆ¶å¾¡
  if (!sessionStorage.getItem("authenticated")) {
    const password = prompt("ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (password !== "wareranochonnma") {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚");
      location.href = "https://www.google.co.jp";
    } else {
      sessionStorage.setItem("authenticated", "true");
    }
  }
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
  authDomain: "maps3-986-ffbbd.firebaseapp.com",
  databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maps3-986-ffbbd",
  storageBucket: "maps3-986-ffbbd.appspot.com",
  messagingSenderId: "701191378459",
  appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const levelColors = {
  "1": "blue", "2": "lightblue", "3": "green",
  "4": "lime", "5": "orange", "6": "red", "7": "purple"
};

const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -3, maxZoom: 2
}).setView([500, 500], -2);

// ã‚°ãƒªãƒƒãƒ‰
for (let i = 0; i <= 1000; i++) {
  L.polyline([[i, 0], [i, 1000]], { color: "#ddd", weight: 0.3 }).addTo(map);
  L.polyline([[0, i], [1000, i]], { color: "#ddd", weight: 0.3 }).addTo(map);
}

window.deleteItem = async function (key) {
  if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    await update(ref(db), { [`coordinates/${key}`]: null });
    alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
    location.reload();
  }
};
window.changeStatus = async function (key) {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "å–å¾—æ¸ˆã¿" });
  alert("å–å¾—æ¸ˆã¿ã«ã—ã¾ã—ãŸï¼");
  location.reload();
};
window.restoreStatus = async function (key) {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "æœªå–å¾—" });
  alert("æœªå–å¾—ã«æˆ»ã—ã¾ã—ãŸï¼");
  location.reload();
};

const form = document.getElementById("coordinateForm");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const x = parseInt(fd.get("X")), y = parseInt(fd.get("Y"));
  const server = fd.get("ã‚µãƒ¼ãƒãƒ¼å"), level = fd.get("ãƒ¬ãƒ™ãƒ«");

  if (!/^\d{3,4}$/.test(server)) return alert("ã‚µãƒ¼ãƒãƒ¼åã¯3ã€œ4æ¡ã§");
  if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) return alert("X/Yã¯0ã€œ999");

  const snap = await get(child(ref(db), "coordinates"));
  const data = snap.exists() ? snap.val() : {};
  for (const k in data) {
    if (+data[k].X === x && +data[k].Y === y) return alert("æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™");
  }

  await push(ref(db, "coordinates"), { ã‚µãƒ¼ãƒãƒ¼å: server, X: x, Y: y, ãƒ¬ãƒ™ãƒ«: level, å–å¾—çŠ¶æ³: "æœªå–å¾—" });
  alert("ç™»éŒ²å®Œäº†ï¼");
  form.reset();
  loadMarkers();
});

// æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨
const filterServer = document.getElementById("filterServer");
const filterLevel = document.getElementById("filterLevel");

filterServer.addEventListener("input", loadMarkers);
filterLevel.addEventListener("change", loadMarkers);

async function loadMarkers() {
  map.eachLayer(layer => {
    if (layer instanceof L.CircleMarker) map.removeLayer(layer);
  });

  const snap = await get(child(ref(db), "coordinates"));
  const items = snap.exists() ? snap.val() : {};

  const serverFilter = filterServer.value.trim().toLowerCase();
  const levelFilter = filterLevel.value;

  for (const key in items) {
    const item = items[key];
    const color = item.å–å¾—çŠ¶æ³ === "æœªå–å¾—" ? (levelColors[item.ãƒ¬ãƒ™ãƒ«] || "gray") : "black";

    // ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    if (serverFilter && !item.ã‚µãƒ¼ãƒãƒ¼å.toLowerCase().includes(serverFilter)) continue;
    if (levelFilter && item.ãƒ¬ãƒ™ãƒ« !== levelFilter) continue;

    const marker = L.circleMarker([+item.Y, +item.X], {
      radius: 3, color, fillOpacity: 1
    }).addTo(map);

    marker.bindPopup(`
      <b>ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å}</b><br>
      ãƒ¬ãƒ™ãƒ«: ${item.ãƒ¬ãƒ™ãƒ«}<br>
      çŠ¶æ…‹: ${item.å–å¾—çŠ¶æ³}<br>
      ${item.å–å¾—çŠ¶æ³ === "æœªå–å¾—"
        ? `<button onclick="window.changeStatus('${key}')">å–å¾—æ¸ˆã¿ã«</button>`
        : `<button onclick="window.restoreStatus('${key}')">æœªå–å¾—ã«æˆ»ã™</button>`}
      <br><button onclick="window.deleteItem('${key}')">å‰Šé™¤</button>
    `);
  }
}
loadMarkers();
</script>

</body>
</html>
