<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åº§æ¨™ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="style/map.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>

<script>
// âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºã¯åˆå›ã®ã¿ï¼ˆsessionStorageã§åˆ¶å¾¡ï¼‰
document.addEventListener("DOMContentLoaded", () => {
  if (!sessionStorage.getItem("authenticated")) {
    const password = prompt("ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (password !== "wareranochonnma") {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚");
      location.href = "https://www.google.co.jp";
    } else {
      sessionStorage.setItem("authenticated", "true");
    }
  }
});
</script>

<h1>åº§æ¨™ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h1>
<form id="coordinateForm">
  <input type="text" name="ã‚µãƒ¼ãƒãƒ¼å" placeholder="3ã€œ4æ¡ã®æ•°å­—" required />
  <input type="number" name="X" placeholder="Xåº§æ¨™ï¼ˆ0ã€œ999ï¼‰" required />
  <input type="number" name="Y" placeholder="Yåº§æ¨™ï¼ˆ0ã€œ999ï¼‰" required />
  <select name="ãƒ¬ãƒ™ãƒ«">
    <option value="1">Lv1</option>
    <option value="2">Lv2</option>
    <option value="3">Lv3</option>
    <option value="4">Lv4</option>
    <option value="5">Lv5</option>
    <option value="6">Lv6</option>
    <option value="7">Lv7</option>
  </select>
  <button type="submit">ç™»éŒ²ã™ã‚‹</button>
</form>

<div id="map"></div>

<button id="toggleUnclaimed">æœªå–å¾—ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>
<button id="toggleClaimed">å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
  authDomain: "maps3-986-ffbbd.firebaseapp.com",
  databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maps3-986-ffbbd",
  storageBucket: "maps3-986-ffbbd.appspot.com",
  messagingSenderId: "701191378459",
  appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const form = document.getElementById("coordinateForm");
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -3,
  maxZoom: 2
}).setView([500, 500], -2);
const levelColors = {
  "1": "blue",
  "2": "lightblue",
  "3": "green",
  "4": "lime",
  "5": "orange",
  "6": "red",
  "7": "purple"
};

// 1000Ã—1000 ã‚°ãƒªãƒƒãƒ‰ç·šã‚’æç”»
for (let y = 0; y <= 1000; y += 50) {
  L.polyline([[y, 0], [y, 1000]], { color: "#ccc", weight: 1 }).addTo(map); // æ¨ªç·š
}
for (let x = 0; x <= 1000; x += 50) {
  L.polyline([[0, x], [1000, x]], { color: "#ccc", weight: 1 }).addTo(map); // ç¸¦ç·š
}





let unclaimedItems = [], claimedItems = [];

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const serverName = formData.get("ã‚µãƒ¼ãƒãƒ¼å");
  const x = parseInt(formData.get("X"));
  const y = parseInt(formData.get("Y"));
  const level = formData.get("ãƒ¬ãƒ™ãƒ«");

  // âœ… é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°ã—ãè¿½åŠ ï¼‰
  const snapshot = await get(child(ref(db), "coordinates"));
  const existingItems = snapshot.exists() ? snapshot.val() : {};

  for (const key in existingItems) {
    const item = existingItems[key];
    if (item.X === x && item.Y === y) {
      alert(`ã“ã®åº§æ¨™ X:${x}, Y:${y} ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™`);
      return;
    }
  }



  if (!/^\d{3,4}$/.test(serverName)) {
    alert("ã‚µãƒ¼ãƒãƒ¼åã¯3ã€œ4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) {
    alert("åº§æ¨™ã¯0ã€œ999ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const data = {
    ã‚µãƒ¼ãƒãƒ¼å: serverName,
    X: x,
    Y: y,
    ãƒ¬ãƒ™ãƒ«: level,
    å–å¾—çŠ¶æ³: "æœªå–å¾—"
  };

  await push(ref(db, "coordinates"), data);
  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
  form.reset();
  loadMarkers();
});

async function loadMarkers() {
  unclaimedItems = [];
  claimedItems = [];

  map.eachLayer(layer => {
    if (layer instanceof L.CircleMarker) map.removeLayer(layer);
  });

  const snapshot = await get(child(ref(db), "coordinates"));
  const items = snapshot.exists() ? snapshot.val() : {};

  for (const key in items) {
    const item = items[key];
    item._id = key;
    (item.å–å¾—çŠ¶æ³ === "æœªå–å¾—" ? unclaimedItems : claimedItems).push(item);

    const coords = [item.Y, item.X];
    const color = levelColors[item.ãƒ¬ãƒ™ãƒ«] || "gray";

    const marker = L.circleMarker([parseInt(item.Y), parseInt(item.X)], {
  radius: 1,
  color: "black",
  fillOpacity: 1
}).addTo(map);

    marker.bindPopup(`
      <b>ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å}</b><br>
      ãƒ¬ãƒ™ãƒ«: ${item.ãƒ¬ãƒ™ãƒ«}<br>
      çŠ¶æ…‹: ${item.å–å¾—çŠ¶æ³}<br>
      ${item.å–å¾—çŠ¶æ³ === "æœªå–å¾—"
        ? `<button onclick="window.changeStatus('${item._id}')">å–å¾—æ¸ˆã¿ã«ã™ã‚‹</button>`
        : `<button onclick="window.restoreStatus('${item._id}')">æœªå–å¾—ã«æˆ»ã™</button>`}
      <br><button onclick="window.deleteItem('${item._id}')">å‰Šé™¤</button>
    `);
  }
}

window.changeStatus = async (key) => {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "å–å¾—æ¸ˆã¿" });
  loadMarkers();
};

window.restoreStatus = async (key) => {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "æœªå–å¾—" });
  alert("æœªå–å¾—ã«æˆ»ã—ã¾ã—ãŸï¼");
  location.reload();
};

};


window.deleteItem = async function(key) {
  if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    await update(ref(db), { [`coordinates/${key}`]: null });
    alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
    location.reload();
  }
};



function openListTab(title, items, type) {
  const win = window.open("", "_blank");
  win.document.write(`
    <html>
    <head><title>${title}</title>
    <style>
      body { font-family: sans-serif; padding: 20px; background:#fafafa; }
      h2 { color: ${type === "unclaimed" ? "purple" : "green"}; }
      ul { list-style: none; padding: 0; }
      li {
        background: #fff;
        border: 1px solid #ccc;
        margin-bottom: 8px;
        padding: 10px;
        font-size: 14px;
      }
      button {
        margin-left: 8px;
        padding: 4px 10px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        background-color: ${type === "unclaimed" ? "#6c63ff" : "darkorange"};
      }
      button:hover {
        background-color: ${type === "unclaimed" ? "#524fcb" : "orangered"};
      }
    </style>
    </head>
    <body>
    <h2>ğŸ“‹ ${title}</h2>
    <ul>
      ${items.map(item => `
        <li>
          ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å} / X:${item.X}, Y:${item.Y} / Lv${item.ãƒ¬ãƒ™ãƒ«}
          ${
            type === "unclaimed"
              ? `<button onclick="window.opener.changeStatus('${item._id}')">å–å¾—æ¸ˆã¿ã«</button>`
              : `<button onclick="window.opener.restoreStatus('${item._id}')">æœªå–å¾—ã«æˆ»ã™</button>`
          }
          <button onclick="window.opener.deleteItem('${item._id}')">å‰Šé™¤</button>
        </li>
      `).join("")}
    </ul>
    </body>
    </html>
  `);
  win.document.close();
}

document.getElementById("toggleUnclaimed").addEventListener("click", () => {
  openListTab("æœªå–å¾—ãƒªã‚¹ãƒˆ", unclaimedItems, "unclaimed");
});
document.getElementById("toggleClaimed").addEventListener("click", () => {
  openListTab("å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆ", claimedItems, "claimed");
});

loadMarkers();
</script>
</body>
</html>

