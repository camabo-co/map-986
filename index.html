<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åº§æ¨™ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>

<!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­· -->
<script>
  const password = prompt("ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (password !== "wareranochonnma") {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚");
    location.href = "https://www.google.co.jp";
  }
</script>

<h1>åº§æ¨™ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h1>
<form id="coordinateForm">
  <input type="text" name="ã‚µãƒ¼ãƒãƒ¼å" placeholder="3ã€œ4æ¡ã®æ•°å­—" required />
  <input type="number" name="X" placeholder="Xåº§æ¨™ï¼ˆ0ã€œ999ï¼‰" required />
  <input type="number" name="Y" placeholder="Yåº§æ¨™ï¼ˆ0ã€œ999ï¼‰" required />
  <select name="ãƒ¬ãƒ™ãƒ«">
    <option value="1">Lv1</option>
    <option value="2">Lv2</option>
    <option value="3">Lv3</option>
    <option value="4">Lv4</option>
    <option value="5">Lv5</option>
    <option value="6">Lv6</option>
    <option value="7">Lv7</option>
  </select>
  <button type="submit">ç™»éŒ²ã™ã‚‹</button>
</form>

<div id="map" style="height: 600px; margin-top: 20px;"></div>

<h2>æœªå–å¾—ãƒªã‚¹ãƒˆ</h2>
<ul id="unclaimedList"></ul>

<h2>å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆ</h2>
<ul id="claimedList"></ul>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
    authDomain: "maps3-986-ffbbd.firebaseapp.com",
    databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "maps3-986-ffbbd",
    storageBucket: "maps3-986-ffbbd.firebasestorage.app",
    messagingSenderId: "701191378459",
    appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const form = document.getElementById("coordinateForm");
  const unclaimedList = document.getElementById("unclaimedList");
  const claimedList = document.getElementById("claimedList");
  const map = L.map("map").setView([500, 500], 1); // ä»®ã®ä¸­å¤®è¡¨ç¤ºï¼ˆX=500,Y=500ï¼‰

  // ğŸ”» èƒŒæ™¯ãªã—ï¼ˆtileLayerå‰Šé™¤ï¼‰

  const levelColors = {
    "1": "blue",
    "2": "lightblue",
    "3": "green",
    "4": "lime",
    "5": "orange",
    "6": "red",
    "7": "purple"
  };

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const serverName = formData.get("ã‚µãƒ¼ãƒãƒ¼å");
    const x = parseInt(formData.get("X"));
    const y = parseInt(formData.get("Y"));
    const level = formData.get("ãƒ¬ãƒ™ãƒ«");

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!/^\d{3,4}$/.test(serverName)) {
      alert("ã‚µãƒ¼ãƒãƒ¼åã¯3ã€œ4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) {
      alert("Xã¨Yåº§æ¨™ã¯0ã€œ999ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    const data = {
      ã‚µãƒ¼ãƒãƒ¼å: serverName,
      X: x,
      Y: y,
      ãƒ¬ãƒ™ãƒ«: level,
      å–å¾—çŠ¶æ³: "æœªå–å¾—"
    };

    await push(ref(db, "coordinates"), data);
    alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
    form.reset();
    loadMarkers();
  });

  async function loadMarkers() {
    unclaimedList.innerHTML = "";
    claimedList.innerHTML = "";
    map.eachLayer(layer => {
      if (layer instanceof L.CircleMarker) map.removeLayer(layer);
    });

    const snapshot = await get(child(ref(db), "coordinates"));
    const items = snapshot.exists() ? snapshot.val() : {};

    for (const key in items) {
      const item = items[key];
      const coords = [item.Y, item.X];
      const color = levelColors[item.ãƒ¬ãƒ™ãƒ«] || "gray";

      const marker = L.circleMarker(coords, {
        radius: 8,
        color: color,
        fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(`
        <b>ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å}</b><br>
        ãƒ¬ãƒ™ãƒ«: ${item.ãƒ¬ãƒ™ãƒ«}<br>
        çŠ¶æ…‹: ${item.å–å¾—çŠ¶æ³}<br>
        ${item.å–å¾—çŠ¶æ³ === "æœªå–å¾—" ? `<button onclick="changeStatus('${key}')">å–å¾—æ¸ˆã¿ã«ã™ã‚‹</button>` : ""}
      `);

      const li = document.createElement("li");
      li.textContent = `ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å} | åº§æ¨™: (${item.X}, ${item.Y}) | Lv${item.ãƒ¬ãƒ™ãƒ«}`;

      if (item.å–å¾—çŠ¶æ³ === "æœªå–å¾—") {
        unclaimedList.appendChild(li);
      } else {
        claimedList.appendChild(li);
      }
    }
  }

  window.changeStatus = async (key) => {
    const updates = {};
    updates["coordinates/" + key + "/å–å¾—çŠ¶æ³"] = "å–å¾—æ¸ˆã¿";
    await update(ref(db), updates);
    loadMarkers();
  };

  loadMarkers();
</script>

</body>
</html>
