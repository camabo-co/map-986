<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åº§æ¨™ãƒãƒƒãƒ—ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }
    #map {
      width: 90vw;
      height: 90vh;
      max-width: 1000px;
      max-height: 1000px;
      margin: 10px auto;
      background-color: #f2f2f2;
    }
    form, .btn-group {
      padding: 10px;
      font-size: 16px;
    }
    input, select, button {
      font-size: 16px;
      padding: 6px;
      margin: 4px;
    }
    button {
      border-radius: 6px;
      border: none;
      background-color: #6c63ff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #524fcb;
    }
  </style>
</head>
<body>

<h2>åº§æ¨™ç™»éŒ²ãƒãƒƒãƒ—</h2>
<form id="coordinateForm">
  <input name="ã‚µãƒ¼ãƒãƒ¼å" placeholder="ã‚µãƒ¼ãƒãƒ¼å (ä¾‹: 986)" required />
  <input name="X" type="number" placeholder="X (0-999)" required />
  <input name="Y" type="number" placeholder="Y (0-999)" required />
  <select name="ãƒ¬ãƒ™ãƒ«" required>
    <option value="" disabled selected>ãƒ¬ãƒ™ãƒ«é¸æŠ</option>
    <option value="1">Lv1</option>
    <option value="2">Lv2</option>
    <option value="3">Lv3</option>
  </select>
  <button type="submit">ç™»éŒ²</button>
</form>

<div class="btn-group">
  <button id="toggleUnclaimed">ğŸ“‹ æœªå–å¾—ãƒªã‚¹ãƒˆ</button>
  <button id="toggleClaimed">ğŸ“‹ å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆ</button>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
  authDomain: "maps3-986-ffbbd.firebaseapp.com",
  databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maps3-986-ffbbd",
  storageBucket: "maps3-986-ffbbd.appspot.com",
  messagingSenderId: "701191378459",
  appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const map = L.map("map", { crs: L.CRS.Simple, minZoom: -3, maxZoom: 2 }).setView([500, 500], -2);

// ã‚°ãƒªãƒƒãƒ‰æç”»
for (let i = 0; i <= 1000; i++) {
  L.polyline([[i, 0], [i, 1000]], { color: "#ccc", weight: 0.2 }).addTo(map);
  L.polyline([[0, i], [1000, i]], { color: "#ccc", weight: 0.2 }).addTo(map);
}

const form = document.getElementById("coordinateForm");
let unclaimedItems = [], claimedItems = [];

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const name = fd.get("ã‚µãƒ¼ãƒãƒ¼å");
  const x = parseInt(fd.get("X"));
  const y = parseInt(fd.get("Y"));
  const level = fd.get("ãƒ¬ãƒ™ãƒ«");

  if (!/^\d{3,4}$/.test(name)) return alert("3ã€œ4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) return alert("åº§æ¨™ã¯0ã€œ999ã§");

  const snap = await get(child(ref(db), "coordinates"));
  const data = snap.exists() ? snap.val() : {};
  for (const key in data) {
    if (parseInt(data[key].X) === x && parseInt(data[key].Y) === y) {
      return alert(`åº§æ¨™ X:${x}, Y:${y} ã¯ç™»éŒ²æ¸ˆã¿`);
    }
  }

  await push(ref(db, "coordinates"), {
    ã‚µãƒ¼ãƒãƒ¼å: name,
    X: x,
    Y: y,
    ãƒ¬ãƒ™ãƒ«: level,
    å–å¾—çŠ¶æ³: "æœªå–å¾—"
  });

  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
  form.reset();
  loadMarkers();
});

async function loadMarkers() {
  unclaimedItems = [];
  claimedItems = [];

  map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });

  const snap = await get(child(ref(db), "coordinates"));
  const items = snap.exists() ? snap.val() : {};

  for (const key in items) {
    const item = items[key];
    item._id = key;
    (item.å–å¾—çŠ¶æ³ === "æœªå–å¾—" ? unclaimedItems : claimedItems).push(item);

    const marker = L.circleMarker([parseInt(item.Y), parseInt(item.X)], {
      radius: 1.5, color: "black", fillOpacity: 1
    }).addTo(map);

    marker.bindPopup(`
      <b>ã‚µãƒ¼ãƒãƒ¼å: ${item.ã‚µãƒ¼ãƒãƒ¼å}</b><br>
      ãƒ¬ãƒ™ãƒ«: ${item.ãƒ¬ãƒ™ãƒ«}<br>
      çŠ¶æ…‹: ${item.å–å¾—çŠ¶æ³}<br>
      <button id="status-${key}">${item.å–å¾—çŠ¶æ³ === "æœªå–å¾—" ? "å–å¾—æ¸ˆã¿ã«" : "æœªå–å¾—ã«æˆ»ã™"}</button>
      <br><button id="delete-${key}">å‰Šé™¤</button>
    `);

    marker.on("popupopen", () => {
      document.getElementById(`status-${key}`)?.addEventListener("click", () => {
        if (item.å–å¾—çŠ¶æ³ === "æœªå–å¾—") {
          changeStatus(key);
        } else {
          restoreStatus(key);
        }
      });
      document.getElementById(`delete-${key}`)?.addEventListener("click", () => {
        deleteItem(key);
      });
    });
  }
}

async function changeStatus(key) {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "å–å¾—æ¸ˆã¿" });
  alert("å–å¾—æ¸ˆã¿ã«ã—ã¾ã—ãŸï¼");
  loadMarkers();
}

async function restoreStatus(key) {
  await update(ref(db), { [`coordinates/${key}/å–å¾—çŠ¶æ³`]: "æœªå–å¾—" });
  alert("æœªå–å¾—ã«æˆ»ã—ã¾ã—ãŸï¼");
  loadMarkers();
}

async function deleteItem(key) {
  if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    await update(ref(db), { [`coordinates/${key}`]: null });
    alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
    loadMarkers();
  }
}

function openListTab(title, items, type) {
  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>${title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 10px; }
      li { margin-bottom: 10px; border: 1px solid #ccc; padding: 8px; }
    </style>
    </head><body>
    <h2>${title}</h2>
    <ul>
    ${items.map(item => `
      <li>
        ${item.ã‚µãƒ¼ãƒãƒ¼å} / X:${item.X}, Y:${item.Y} / Lv${item.ãƒ¬ãƒ™ãƒ«}
      </li>`).join("")}
    </ul>
    </body></html>
  `);
  win.document.close();
}

document.getElementById("toggleUnclaimed").addEventListener("click", () => {
  openListTab("æœªå–å¾—ãƒªã‚¹ãƒˆ", unclaimedItems, "unclaimed");
});
document.getElementById("toggleClaimed").addEventListener("click", () => {
  openListTab("å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆ", claimedItems, "claimed");
});

loadMarkers();
</script>

</body>
</html>
