<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>座標マップ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const password = prompt("このページにアクセスするにはパスワードを入力してください");
    if (password !== "wareranochonnma") {
      alert("パスワードが違います。アクセスできません。");
      location.href = "https://www.google.co.jp";
    }
  });
</script>

<h1>座標登録フォーム</h1>
<form id="coordinateForm">
  <input type="text" name="サーバー名" placeholder="3〜4桁の数字" required />
  <input type="number" name="X" placeholder="X座標（0〜999）" required />
  <input type="number" name="Y" placeholder="Y座標（0〜999）" required />
  <select name="レベル">
    <option value="1">Lv1</option>
    <option value="2">Lv2</option>
    <option value="3">Lv3</option>
    <option value="4">Lv4</option>
    <option value="5">Lv5</option>
    <option value="6">Lv6</option>
    <option value="7">Lv7</option>
  </select>
  <button type="submit">登録する</button>
</form>

<div id="map" style="height: 600px; margin-top: 20px;"></div>

<!-- リスト表示切替ボタン -->
<button id="toggleUnclaimed">未取得リストを表示</button>
<ul id="unclaimedList" style="display: none;"></ul>

<button id="toggleClaimed">取得済みリストを表示</button>
<ul id="claimedList" style="display: none;"></ul>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
    authDomain: "maps3-986-ffbbd.firebaseapp.com",
    databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "maps3-986-ffbbd",
    storageBucket: "maps3-986-ffbbd.appspot.com",
    messagingSenderId: "701191378459",
    appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const form = document.getElementById("coordinateForm");
  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 2
  }).setView([500, 500], 0);

  // グリッド描画
  for (let x = 0; x <= 1000; x += 100) {
    L.polyline([[0, x], [1000, x]], { color: "#ccc", weight: 1 }).addTo(map);
  }
  for (let y = 0; y <= 1000; y += 100) {
    L.polyline([[y, 0], [y, 1000]], { color: "#ccc", weight: 1 }).addTo(map);
  }

  const levelColors = {
    "1": "blue", "2": "lightblue", "3": "green", "4": "lime",
    "5": "orange", "6": "red", "7": "purple"
  };

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const serverName = formData.get("サーバー名");
    const x = parseInt(formData.get("X"));
    const y = parseInt(formData.get("Y"));
    const level = formData.get("レベル");

    if (!/^\d{3,4}$/.test(serverName)) {
      alert("サーバー名は3〜4桁の数字で入力してください");
      return;
    }
    if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) {
      alert("座標は0〜999の範囲で入力してください");
      return;
    }

    const data = {
      サーバー名: serverName,
      X: x, Y: y, レベル: level,
      取得状況: "未取得"
    };

    await push(ref(db, "coordinates"), data);
    alert("登録しました！");
    form.reset();
    loadMarkers();
  });

  async function loadMarkers() {
    const unclaimedList = document.getElementById("unclaimedList");
    const claimedList = document.getElementById("claimedList");
    unclaimedList.innerHTML = "";
    claimedList.innerHTML = "";

    map.eachLayer(layer => {
      if (layer instanceof L.CircleMarker) map.removeLayer(layer);
    });

    const snapshot = await get(child(ref(db), "coordinates"));
    const items = snapshot.exists() ? snapshot.val() : {};

    const unclaimedItems = [], claimedItems = [];

    for (const key in items) {
      const item = items[key];
      item._id = key;
      (item.取得状況 === "未取得" ? unclaimedItems : claimedItems).push(item);
    }

    unclaimedItems.sort((a, b) => parseInt(a.レベル) - parseInt(b.レベル));
    claimedItems.sort((a, b) => parseInt(a.レベル) - parseInt(b.レベル));

    [...unclaimedItems, ...claimedItems].forEach(item => {
      const coords = [item.Y, item.X];
      const color = levelColors[item.レベル] || "gray";

      const marker = L.circleMarker(coords, {
        radius: 8, color: color, fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(`
        <b>サーバー名: ${item.サーバー名}</b><br>
        レベル: ${item.レベル}<br>
        状態: ${item.取得状況}<br>
        ${
          item.取得状況 === "未取得"
            ? `<button onclick="changeStatus('${item._id}')">取得済みにする</button>`
            : `<button onclick="restoreStatus('${item._id}')">未取得に戻す</button>`
        }
      `);
    });

    unclaimedItems.forEach(item => {
      const li = document.createElement("li");
      li.textContent = `サーバー名: ${item.サーバー名} | 座標: (${item.X}, ${item.Y}) | Lv${item.レベル}`;
      const btn = document.createElement("button");
      btn.textContent = "取得済みに変更";
      btn.onclick = () => changeStatus(item._id);
      li.appendChild(btn);
      unclaimedList.appendChild(li);
    });

    claimedItems.forEach(item => {
      const li = document.createElement("li");
      li.textContent = `サーバー名: ${item.サーバー名} | 座標: (${item.X}, ${item.Y}) | Lv${item.レベル}`;
      const btn = document.createElement("button");
      btn.textContent = "未取得に戻す";
      btn.onclick = () => restoreStatus(item._id);
      li.appendChild(btn);
      claimedList.appendChild(li);
    });
  }

  window.changeStatus = async (key) => {
    await update(ref(db), { [`coordinates/${key}/取得状況`]: "取得済み" });
    loadMarkers();
  };

  window.restoreStatus = async (key) => {
    await update(ref(db), { [`coordinates/${key}/取得状況`]: "未取得" });
    loadMarkers();
  };

  loadMarkers();

  // リスト表示切り替え
  document.getElementById("toggleUnclaimed").addEventListener("click", () => {
    const list = document.getElementById("unclaimedList");
    const btn = document.getElementById("toggleUnclaimed");
    const visible = list.style.display === "block";
    list.style.display = visible ? "none" : "block";
    btn.textContent = visible ? "未取得リストを表示" : "未取得リストを非表示";
  });

  document.getElementById("toggleClaimed").addEventListener("click", () => {
    const list = document.getElementById("claimedList");
    const btn = document.getElementById("toggleClaimed");
    const visible = list.style.display === "block";
    list.style.display = visible ? "none" : "block";
    btn.textContent = visible ? "取得済みリストを表示" : "取得済みリストを非表示";
  });
</script>
</body>
</html>
