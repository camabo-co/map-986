<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>座標マップ（スマホ対応）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }
    #map {
      width: 90vw;
      height: 90vh;
      max-width: 1000px;
      max-height: 1000px;
      margin: 10px auto;
      background-color: #f2f2f2;
    }
    form, .btn-group {
      padding: 10px;
      font-size: 16px;
    }
    input, select, button {
      font-size: 16px;
      padding: 6px;
      margin: 4px;
    }
    button {
      border-radius: 6px;
      border: none;
      background-color: #6c63ff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #524fcb;
    }
  </style>
</head>
<body>

<h2>座標登録マップ</h2>
<form id="coordinateForm">
  <input name="サーバー名" placeholder="サーバー名 (例: 986)" required />
  <input name="X" type="number" placeholder="X (0-999)" required />
  <input name="Y" type="number" placeholder="Y (0-999)" required />
  <select name="レベル" required>
    <option value="" disabled selected>レベル選択</option>
    <option value="1">Lv1</option>
    <option value="2">Lv2</option>
    <option value="3">Lv3</option>
  </select>
  <button type="submit">登録</button>
</form>

<div class="btn-group">
  <button id="toggleUnclaimed">📋 未取得リスト</button>
  <button id="toggleClaimed">📋 取得済みリスト</button>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdNI04D1xhQihN3DBDdF1_YAp6XRcErDw",
  authDomain: "maps3-986-ffbbd.firebaseapp.com",
  databaseURL: "https://maps3-986-ffbbd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maps3-986-ffbbd",
  storageBucket: "maps3-986-ffbbd.appspot.com",
  messagingSenderId: "701191378459",
  appId: "1:701191378459:web:d2cf8d869f5cba869d0abe"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const map = L.map("map", { crs: L.CRS.Simple, minZoom: -3, maxZoom: 2 }).setView([500, 500], -2);

// グリッド描画
for (let i = 0; i <= 1000; i++) {
  L.polyline([[i, 0], [i, 1000]], { color: "#ccc", weight: 0.2 }).addTo(map);
  L.polyline([[0, i], [1000, i]], { color: "#ccc", weight: 0.2 }).addTo(map);
}

const form = document.getElementById("coordinateForm");
let unclaimedItems = [], claimedItems = [];

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const name = fd.get("サーバー名");
  const x = parseInt(fd.get("X"));
  const y = parseInt(fd.get("Y"));
  const level = fd.get("レベル");

  if (!/^\d{3,4}$/.test(name)) return alert("3〜4桁の数字で入力してください");
  if (isNaN(x) || x < 0 || x > 999 || isNaN(y) || y < 0 || y > 999) return alert("座標は0〜999で");

  const snap = await get(child(ref(db), "coordinates"));
  const data = snap.exists() ? snap.val() : {};
  for (const key in data) {
    if (parseInt(data[key].X) === x && parseInt(data[key].Y) === y) {
      return alert(`座標 X:${x}, Y:${y} は登録済み`);
    }
  }

  await push(ref(db, "coordinates"), {
    サーバー名: name,
    X: x,
    Y: y,
    レベル: level,
    取得状況: "未取得"
  });

  alert("登録しました！");
  form.reset();
  loadMarkers();
});

async function loadMarkers() {
  unclaimedItems = [];
  claimedItems = [];

  map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });

  const snap = await get(child(ref(db), "coordinates"));
  const items = snap.exists() ? snap.val() : {};

  for (const key in items) {
    const item = items[key];
    item._id = key;
    (item.取得状況 === "未取得" ? unclaimedItems : claimedItems).push(item);

    const marker = L.circleMarker([parseInt(item.Y), parseInt(item.X)], {
      radius: 1.5, color: "black", fillOpacity: 1
    }).addTo(map);

    marker.bindPopup(`
      <b>サーバー名: ${item.サーバー名}</b><br>
      レベル: ${item.レベル}<br>
      状態: ${item.取得状況}<br>
      <button id="status-${key}">${item.取得状況 === "未取得" ? "取得済みに" : "未取得に戻す"}</button>
      <br><button id="delete-${key}">削除</button>
    `);

    marker.on("popupopen", () => {
      document.getElementById(`status-${key}`)?.addEventListener("click", () => {
        if (item.取得状況 === "未取得") {
          changeStatus(key);
        } else {
          restoreStatus(key);
        }
      });
      document.getElementById(`delete-${key}`)?.addEventListener("click", () => {
        deleteItem(key);
      });
    });
  }
}

async function changeStatus(key) {
  await update(ref(db), { [`coordinates/${key}/取得状況`]: "取得済み" });
  alert("取得済みにしました！");
  loadMarkers();
}

async function restoreStatus(key) {
  await update(ref(db), { [`coordinates/${key}/取得状況`]: "未取得" });
  alert("未取得に戻しました！");
  loadMarkers();
}

async function deleteItem(key) {
  if (confirm("削除しますか？")) {
    await update(ref(db), { [`coordinates/${key}`]: null });
    alert("削除しました！");
    loadMarkers();
  }
}

function openListTab(title, items, type) {
  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>${title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: sans-serif; padding: 10px; }
      li { margin-bottom: 10px; border: 1px solid #ccc; padding: 8px; }
    </style>
    </head><body>
    <h2>${title}</h2>
    <ul>
    ${items.map(item => `
      <li>
        ${item.サーバー名} / X:${item.X}, Y:${item.Y} / Lv${item.レベル}
      </li>`).join("")}
    </ul>
    </body></html>
  `);
  win.document.close();
}

document.getElementById("toggleUnclaimed").addEventListener("click", () => {
  openListTab("未取得リスト", unclaimedItems, "unclaimed");
});
document.getElementById("toggleClaimed").addEventListener("click", () => {
  openListTab("取得済みリスト", claimedItems, "claimed");
});

loadMarkers();
</script>

</body>
</html>
